name: Sign macOS and iOS Artifacts

on:
  workflow_run:
    workflows: ["Build Kebap"]
    types:
      - completed

jobs:
  sign-and-notarize:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: kebap-macOS
          path: artifacts/macos

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: kebap-iOS
          path: artifacts/ios

      - name: Decode and install signing certificate (P12)
        env:
          P12_BASE64: ${{ secrets.APPLE_SIGN_CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_SIGN_CERT_P12_PASSWORD }}
        run: |
          if [ -z "$P12_BASE64" ]; then
            echo "P12 secret not provided, skipping certificate import"
            exit 1
          fi
          echo "$P12_BASE64" | base64 -d > cert.p12
          SECURITY_PW="ci-keychain-pass"
          security create-keychain -p "$SECURITY_PW" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import cert.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign -T /usr/bin/security
          security list-keychains -s build.keychain
          security unlock-keychain -p "$SECURITY_PW" build.keychain

      - name: Sign macOS app, create DMG and notarize
        env:
          MAC_SIGN_IDENTITY: ${{ secrets.APPLE_MAC_SIGN_IDENTITY }}
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER: ${{ secrets.APP_STORE_CONNECT_API_ISSUER }}
        run: |
          set -e
          APP_DIR="artifacts/macos/build/macos/Build/Products/Release-production"
          # try common app locations
          if [ -d "$APP_DIR" ]; then
            APP_PATH=$(find "$APP_DIR" -maxdepth 1 -name "*.app" | head -n 1)
          else
            APP_PATH=$(find artifacts/macos -name "*.app" | head -n 1)
          fi
          if [ -z "$APP_PATH" ]; then
            echo "macOS .app not found in artifacts; skipping macOS signing"
            exit 0
          fi
          echo "Found app at: $APP_PATH"
          echo "Codesigning app with identity: $MAC_SIGN_IDENTITY"
          codesign --deep --force --options runtime --timestamp --sign "$MAC_SIGN_IDENTITY" "$APP_PATH"
          codesign --verify --deep --strict --verbose=2 "$APP_PATH" || true

          # Create DMG using included helper if present
          if [ -x "./scripts/create_dmg.sh" ]; then
            ./scripts/create_dmg.sh
            DMG_PATH="build/macos/Build/Products/Release-production/macOS.dmg"
            if [ ! -f "$DMG_PATH" ]; then
              # fallback: find a dmg
              DMG_PATH=$(find . -name "*.dmg" | head -n 1)
            fi
          else
            DMG_PATH=$(find . -name "*.dmg" | head -n 1)
          fi

          if [ -z "$DMG_PATH" ]; then
            echo "DMG not produced; skipping notarization"
            exit 0
          fi

          echo "DMG created at: $DMG_PATH"

          if [ -z "$API_KEY_BASE64" ] || [ -z "$API_KEY_ID" ] || [ -z "$API_ISSUER" ]; then
            echo "App Store Connect API key not provided; skipping notarization"
            exit 0
          fi

          echo "$API_KEY_BASE64" | base64 -d > AuthKey.p8
          xcrun notarytool submit "$DMG_PATH" --key AuthKey.p8 --key-id "$API_KEY_ID" --issuer "$API_ISSUER" --wait
          xcrun stapler staple "$DMG_PATH" || true

      - name: Sign iOS archive and export IPA
        env:
          IOS_SIGN_IDENTITY: ${{ secrets.APPLE_IOS_SIGN_IDENTITY }}
          MOBILEPROVISION_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
          BUNDLE_ID: ${{ secrets.APP_BUNDLE_ID }}
        run: |
          set -e
          ARCHIVE_PATH="artifacts/ios/build/ios/archive/Runner.xcarchive"
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "iOS archive not found at $ARCHIVE_PATH; skipping iOS signing"
            exit 0
          fi

          # Install provisioning profile if provided
          if [ -n "$MOBILEPROVISION_BASE64" ]; then
            echo "$MOBILEPROVISION_BASE64" | base64 -d > profile.mobileprovision
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
            echo "Installed provisioning profile"
          fi

          # Create ExportOptions.plist for export
          EXPORT_PLIST=exportOptions.plist
          cat > $EXPORT_PLIST <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>app-store</string>
  <key>signingStyle</key>
  <string>manual</string>
  <key>compileBitcode</key>
  <true/>
  <key>manageAppVersionAndBuildNumber</key>
  <false/>
</dict>
</plist>
EOF

          EXPORT_DIR=ios_export
          mkdir -p $EXPORT_DIR
          xcodebuild -exportArchive -archivePath "$ARCHIVE_PATH" -exportOptionsPlist $EXPORT_PLIST -exportPath $EXPORT_DIR || { echo "xcodebuild export failed"; exit 1; }
          IPA_PATH=$(find $EXPORT_DIR -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "Exported IPA not found"
            exit 1
          fi
          echo "Exported IPA: $IPA_PATH"

      - name: Upload signed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kebap-macos-signed
          path: |
            signed-macOS.dmg || artifacts/macos
